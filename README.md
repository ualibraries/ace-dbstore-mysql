# ACE DBStore Mysql docker

- [Introduction](#introduction)
- [Background](#background)
- [Dependencies](#dependencies)
- [Environment Variables](#environment-variables)
- [Deployment](#deployment)

## Introduction

This docker image is provided to automatically create the databases needed to run [Ace Integrity Management Service](https://wiki.umiacs.umd.edu/adapt/index.php/Ace:Ace_IMS_System) (ace-ims) and multiple instances of an [Ace Audit Manager](https://wiki.umiacs.umd.edu/adapt/index.php/Ace:Main) (ace-am), which taken together form the ACE [Auditing Control Environment](https://wiki.umiacs.umd.edu/adapt/index.php/Ace).

This docker image is part of a set created by the [University of Arizona Libraries](https://github.com/ualibraries) to implement open fixity solutions based on [Ace Audit Manager](https://wiki.umiacs.umd.edu/adapt/index.php/Ace:Main)

* [ace-dbstore-mysql](https://github.com/ualibraries/ace-dbstore-mysql) - provides a [mysql](https://hub.docker.com/_/mysql/) instance that will auto-create a dynamic number of ace-audit-manager databases and one ace-integrity-manager database.
* [ace-integrity-management](https://github.com/ualibraries/ace-integrity-management) - provides the [Ace Integrity Management Service](https://wiki.umiacs.umd.edu/adapt/index.php/Ace:Ace_IMS_System) service, running within the [glassfish](https://en.wikipedia.org/wiki/GlassFish) based [Payara](https://www.payara.fish/) J2EE application container.
* [ace-audit-manager](https://github.com/ualibraries/ace-audit-manager) - provides the [Ace Audit Manager Service](https://wiki.umiacs.umd.edu/adapt/index.php/Ace:Audit_Manager_Installation_Guide) fixity calculation and verification service, running within a [tomcat 8.5](http://tomcat.apache.org/) web servlet container.

## Background

When looking over the ACE [architecture](https://wiki.umiacs.umd.edu/adapt/images/5/5b/DigCCurr2009_060909.pdf) the ace-am's role is to provide fixity auditing of an archival collection, generating checksums of files to enable the auditing. The role of the ace-ims is to prove the checksum's generated by an audit manager have not gotten corrupted. This docker container provides the database storage for the above services.

There is usually many deployments of ACE Audit Manager which all connect to the same ACE Integrity Management Service.

This docker image was created via from the database creation portion of [manual instructions](https://wiki.umiacs.umd.edu/adapt/index.php/Ace:Audit_Manager_Installation_Guide) for setting up the ACE audit manager. The [source code](https://gitlab.umiacs.umd.edu/adapt/ace) for the entire ACE suite is hosted on [gitlab](https://gitlab.umiacs.umd.edu/groups/adapt)

A good [comparison chart](http://digitalpowrr.niu.edu/digital-preservation-101/tool-grid/) between different archiveval storage systems is provided by digitalpowrr.

## Dependencies
### Host system dependencies
1. [docker-compose](https://docs.docker.com/compose/overview/) is installed on the system.
2. No other service on the system is listening at port 3306.
3. For production instances, a persistant place to store the mysql data files mounted into the docker image at /var/lib/mysql.

## Environment Variables

The following environment variables control the docker setup.

Notice the ACE1...ACEn environment variables. They allow for specifying n Ace Audit Manager database instances, where the ACEn_AM_DATABASE, ACEn_AMDBA_USER, ACEn_AMDBA_PASSWORD triplet variables each need to be defined.

* ACE_DBSTORE - This host directory location to persistantly store data files. The default is to create a non-persistant, temporary docker volume called 'dbstore'.
* ACE_IMS_DATABASE - the ace-ims database name to create, defaults to 'imsdb'.
* ACE_IMSDBA_USER - the ace-ims dba user to create, defaults to 'aceims'.
* ACE_IMSDBA_PASSWORD - the ace-ims dba user password, defaults to 'ace'.
* ACE1_AM_DATABASE - the first ace-am database name to create, defaults to 'amdb1'.
* ACE1_AMDBA_USER - the first ace-am dba user to create, defaults to 'aceam1'.
* ACE1_AMDBA_PASSWORD - the first ace-am dba user password, defaults to 'ace'.
* ACEn_AM_DATABASE - the nth ace-am database name to create, defaults to ''.
* ACEn_AMDBA_USER - the nth ace-am dba user to create, defaults to ''.
* ACEn_AMDBA_PASSWORD - the nth ace-am dba user password, defaults to ''.

## Deployment

There are a couple docker-compose deployments provided:

1. [Self contained](#self-contained)
2. [Singleton](#singleton)

## Self contained

A self-contained docker-compose example integrating all three components (ace-am, ace-ims, ace-dbstore) is located at [compose/fixity](https://github.com/ualibraries/ace-dbstore-mysql/tree/master/compose/fixity). As an external dependency, if an smtp service is available then this docker-compose provides a way to quickly install and try out the full [ACE Auditing Control Environment](https://wiki.umiacs.umd.edu/adapt/index.php/Ace) product suite.

In looking over the self-contained  [docker-compose.yml](https://github.com/ualibraries/ace-dbstore-mysql/blob/master/compose/fixity/docker-compose.yml) file, one important detail to note is ACE Audit Manager is accessible through port 8090 rather than the standard 8080. This is to allow the ACE Integrity Management service to run at the standard port 8080.

To test out the suite, run the following commands:

```
	
	git clone https://github.com/ualibraries/ace-dbstore-mysql.git
	cd ace-dbstore-mysql/compose/fixity
	docker-compose up -d
	
```

Next, the configuration needs to get updated to use the local ace-ims docker container and the smtp server:

1. Click on the the [System Settings](http://localhost:8090/ace-am/UpdateSettings) link, the user/pswd is 'admin/admin'.
2. Change the 'IMS Host' entry from 'ims.umiacs.umd.edu' to 'integrity'.
3. Update the 'Mail Server' to the value for your organization's smtp server.
4. Update the 'Mail From' account to reflect the correct notification email address.
5. To commit the updated values hit the 'Submit' link at the bottom of the page.

Then browse to [http://localhost:8090/ace-am](http://localhost:8090/ace-am). Follow the [3. Register your first collection](https://wiki.umiacs.umd.edu/adapt/index.php/Ace:Audit_Manager_Installation_Guide) instructions to setup the first archive share to audit. The docker image mounts /mnt from the host into to docker container, so any host shares that have been mounted to /mnt will be available to create a collection with for fixity auditing.

To see if the ace-ims is working correctly, follow the ["Then browse to..."](https://github.com/ualibraries/ace-integrity-management#self-contained) directions for the [ace-integrity-management](https://github.com/ualibraries/ace-integrity-management).

To cleanup the above test instance, run:

```
	
	git clone https://github.com/ualibraries/ace-dbstore-mysql.git
	cd ace-dbstore-mysql/compose/fixity
	docker-compose rm -fsv
	docker volume prune  # Enter y
	
```

Three docker containers will be created, validate by running **docker ps -a**

* fixity_audit_1 - contains ace audit manager running under tomcat
* fixity_integrity_1 - contains ace integrity manager running under payara.
* fixity_dbstore_1 - contains a mysql database used by ace audit manager.

## Singleton

The singleton docker-compose example located at [compose/ace](https://github.com/ualibraries/ace-dbstore-mysql/tree/master/compose/ace) just installs the ace-dbstore by itself to provide the database instances needed by an external ace-ims and multiple ace-am.

This docker-compose example is more likely to be used in a production environment where there is a dedicated database and ace-ims machine that are used by a number of ace-am machines.

